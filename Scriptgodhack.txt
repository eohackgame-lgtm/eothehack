local VirtualInputManager = game:GetService("VirtualInputManager")
local CollectionService = game:GetService("CollectionService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TeleportService = game:GetService("TeleportService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local Player = Players.LocalPlayer

-- 檢查是否成功獲取本地玩家
if not Player then
    warn("無法找到玩家。請確保您在客戶端運行腳本。")
    return
end

local PlayerGui = Player:WaitForChild("PlayerGui")

-- 顯示通知（加載時自動顯示）
game.StarterGui:SetCore("SendNotification", {
    Title = "eoHub",
    Text = "成功運行，測試階段請別亂用",
    Duration = 999
})

-- 創建主屏幕GUI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "SimpleGUI"
ScreenGui.Parent = PlayerGui
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

-- 創建圖標按鈕
local IconButton = Instance.new("ImageButton")
IconButton.Name = "IconButton"
IconButton.Size = UDim2.new(0, 60, 0, 60)
IconButton.Position = UDim2.new(0, 20, 0, 20)
IconButton.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
IconButton.BackgroundTransparency = 0.5
IconButton.Image = "rbxassetid://138136991120099"
IconButton.ScaleType = Enum.ScaleType.Fit
IconButton.Parent = ScreenGui

-- 創建圓角效果
local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0.2, 0)
UICorner.Parent = IconButton

-- 創建主面板 (高度改為400，是原本200的2倍)
local MainPanel = Instance.new("Frame")
MainPanel.Name = "MainPanel"
MainPanel.Size = UDim2.new(0, 300, 0, 400)  -- 高度改為400
MainPanel.Position = UDim2.new(0, 90, 0, 20)
MainPanel.BackgroundColor3 = Color3.fromRGB(0,0,0)
MainPanel.BackgroundTransparency = 0.1
MainPanel.Visible = false
MainPanel.Parent = ScreenGui

local MainPanelCorner = Instance.new("UICorner")
MainPanelCorner.CornerRadius = UDim.new(0.05, 0)
MainPanelCorner.Parent = MainPanel

-- 創建信息頁面面板
local InfoPanel = Instance.new("Frame")
InfoPanel.Name = "InfoPanel"
InfoPanel.Size = UDim2.new(0, 300, 0, 200)
InfoPanel.Position = UDim2.new(0, 90, 0, 20)
InfoPanel.BackgroundColor3 = Color3.fromRGB(0,0,0)
InfoPanel.BackgroundTransparency = 0.1
InfoPanel.Visible = false
InfoPanel.Parent = ScreenGui

local InfoPanelCorner = Instance.new("UICorner")
InfoPanelCorner.CornerRadius = UDim.new(0.05, 0)
InfoPanelCorner.Parent = InfoPanel

-- 在主面板添加传送按钮
local teleportButton = Instance.new("TextButton")
teleportButton.Name = "TeleportButton"
teleportButton.Size = UDim2.new(0, 150, 0, 40)
teleportButton.Position = UDim2.new(0, 20, 0, 20)
teleportButton.BackgroundColor3 = Color3.fromRGB(80, 200, 120)
teleportButton.Text = "自動海上飛行(標準位置在司法後面啟飛)"
teleportButton.TextColor3 = Color3.fromRGB(255, 255, 255)
teleportButton.TextScaled = true
teleportButton.Parent = MainPanel

-- 在主面板添加停止按钮
local stopButton = Instance.new("TextButton")
stopButton.Name = "StopButton"
stopButton.Size = UDim2.new(0, 150, 0, 40)
stopButton.Position = UDim2.new(0, 20, 0, 70)
stopButton.BackgroundColor3 = Color3.fromRGB(200, 80, 80)
stopButton.Text = "停止移動"
stopButton.TextColor3 = Color3.fromRGB(255, 255, 255)
stopButton.TextScaled = true
stopButton.Parent = MainPanel

-- 在主面板添加信息页面按钮
local infoButton = Instance.new("TextButton")
infoButton.Name = "InfoButton"
infoButton.Size = UDim2.new(0, 150, 0, 40)
infoButton.Position = UDim2.new(0, 20, 0, 120)
infoButton.BackgroundColor3 = Color3.fromRGB(80, 120, 200)
infoButton.Text = "顯示信息"
infoButton.TextColor3 = Color3.fromRGB(255, 255, 255)
infoButton.TextScaled = true
infoButton.Parent = MainPanel

-- 在主面板添加飛到Tiki的按钮 (新增按鈕，放在原按鈕下方)
local flyToTikiButton = Instance.new("TextButton")
flyToTikiButton.Name = "FlyToTikiButton"
flyToTikiButton.Size = UDim2.new(0, 150, 0, 40)
flyToTikiButton.Position = UDim2.new(0, 20, 0, 170)
flyToTikiButton.BackgroundColor3 = Color3.fromRGB(180, 100, 220)  -- 紫色系
flyToTikiButton.Text = "飛到Tiki"
flyToTikiButton.TextColor3 = Color3.fromRGB(255, 255, 255)
flyToTikiButton.TextScaled = true
flyToTikiButton.Parent = MainPanel

-- 在信息页面添加返回按钮
local backButton = Instance.new("TextButton")
backButton.Name = "BackButton"
backButton.Size = UDim2.new(0, 150, 0, 40)
backButton.Position = UDim2.new(0, 20, 0, 120)
backButton.BackgroundColor3 = Color3.fromRGB(200, 120, 80)
backButton.Text = "返回主頁"
backButton.TextColor3 = Color3.fromRGB(255, 255, 255)
backButton.TextScaled = true
backButton.Parent = InfoPanel

-- 在信息页面添加信息文本
local infoText = Instance.new("TextLabel")
infoText.Name = "InfoText"
infoText.Size = UDim2.new(0, 260, 0, 100)
infoText.Position = UDim2.new(0, 20, 0, 20)
infoText.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
infoText.BackgroundTransparency = 0.3
infoText.Text = "eoHub 信息頁面\n\n版本: E1.5\n功能: 自動海上飛行、自動到司法\n作者: eoHub團隊"
infoText.TextColor3 = Color3.fromRGB(255, 255, 255)
infoText.TextScaled = true
infoText.Font = Enum.Font.Gotham
infoText.Parent = InfoPanel

-- 为所有按钮添加圆角
local teleportCorner = Instance.new("UICorner")
teleportCorner.CornerRadius = UDim.new(0, 8)
teleportCorner.Parent = teleportButton

local stopCorner = Instance.new("UICorner")
stopCorner.CornerRadius = UDim.new(0, 8)
stopCorner.Parent = stopButton

local infoCorner = Instance.new("UICorner")
infoCorner.CornerRadius = UDim.new(0, 8)
infoCorner.Parent = infoButton

local flyToTikiCorner = Instance.new("UICorner")
flyToTikiCorner.CornerRadius = UDim.new(0, 8)
flyToTikiCorner.Parent = flyToTikiButton

local backCorner = Instance.new("UICorner")
backCorner.CornerRadius = UDim.new(0, 8)
backCorner.Parent = backButton

local infoTextCorner = Instance.new("UICorner")
infoTextCorner.CornerRadius = UDim.new(0, 8)
infoTextCorner.Parent = infoText

-- 控制变量
local isMoving = false
local moveConnection = nil

-- 移動功能
teleportButton.MouseButton1Click:Connect(function()
    if not Player.Character then return end
    
    local humanoidRootPart = Player.Character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return end
    
    isMoving = true
    
    game.StarterGui:SetCore("SendNotification", {
        Title = "移動中",
        Text = "正在移動，速度300...",
        Duration = 3
    })
    
    -- 獲取當前位置
    local currentPos = humanoidRootPart.Position
    local currentCFrame = humanoidRootPart.CFrame
    
    -- 向左旋轉90度（使船頭朝向移動方向的右側）
    local rotatedCFrame = currentCFrame * CFrame.Angles(0, math.rad(90), 0)
    
    -- 執行初始位置設定 (高度180，並旋轉90度)
    humanoidRootPart.CFrame = CFrame.new(currentPos.X, 180, currentPos.Z) * CFrame.Angles(0, math.rad(90), 0)
    
    -- 持續移動
    moveConnection = RunService.Heartbeat:Connect(function(deltaTime)
        if not isMoving or not Player.Character then
            moveConnection:Disconnect()
            return
        end
        
        local hrp = Player.Character:FindFirstChild("HumanoidRootPart")
        if hrp then
            local currentPos = hrp.Position
            -- 計算新的X位置，速度為300每秒，向負方向移動
            local newX = currentPos.X - (300 * deltaTime)
            
            -- 設置新位置 (保持Z不變，高度180，X軸負方向移動，保持旋轉)
            hrp.CFrame = CFrame.new(newX, 180, currentPos.Z) * CFrame.Angles(0, math.rad(90), 0)
        end
    end)
end)

-- 停止功能
stopButton.MouseButton1Click:Connect(function()
    isMoving = false
    
    if moveConnection then
        moveConnection:Disconnect()
        moveConnection = nil
    end
    
    game.StarterGui:SetCore("SendNotification", {
        Title = "已停止",
        Text = "移動已停止",
        Duration = 3
    })
end)

-- 信息按钮功能
infoButton.MouseButton1Click:Connect(function()
    MainPanel.Visible = false
    InfoPanel.Visible = true
end)

-- 返回按钮功能
backButton.MouseButton1Click:Connect(function()
    InfoPanel.Visible = false
    MainPanel.Visible = true
end)

-- 圖標點擊事件（只顯示主面板，不發送通知）
IconButton.MouseButton1Click:Connect(function()
    MainPanel.Visible = not MainPanel.Visible
    InfoPanel.Visible = false -- 確保信息面板隱藏
end)

-- ========== 飛到Tiki功能代碼開始 ==========
-- 飛行控制變量（飛到Tiki）
local isFlyingToTiki = false
local flyConnection = nil
local targetX = -16542  -- Tiki島X座標
local targetZ = 1044    -- Tiki島Z座標
local initialY = 500    -- 初始飛行高度
local finalY = 800      -- 最終飛行高度
local targetY = initialY -- 當前目標高度
local flightPhase = "ascending" -- 飛行階段: "ascending", "waiting", "ascendingTo800", "horizontal", "descending"
local waitTimer = 0

-- 檢查是否到達目標位置
local function hasReachedTarget(currentPos)
    local tolerance = 5  -- 容錯範圍
    return math.abs(currentPos.X - targetX) < tolerance and math.abs(currentPos.Z - targetZ) < tolerance
end

-- 檢測下方是否有地面
local function findGroundBelow(position)
    local rayOrigin = Vector3.new(position.X, position.Y + 10, position.Z)
    local rayDirection = Vector3.new(0, -1000, 0)
    local raycastParams = RaycastParams.new()
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
    
    if Player.Character then
        raycastParams.FilterDescendantsInstances = {Player.Character}
    end
    
    local raycastResult = workspace:Raycast(rayOrigin, rayDirection, raycastParams)
    
    if raycastResult then
        return raycastResult.Position.Y + 5  -- 在地面位置上方5單位
    end
    
    return position.Y - 100  -- 如果沒檢測到，下降100單位
end

-- 飛行功能
local function startFlyToTiki()
    if not Player.Character then 
        warn("沒有找到玩家角色")
        return 
    end
    
    local humanoidRootPart = Player.Character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then 
        warn("沒有找到 HumanoidRootPart")
        return 
    end
    
    -- 如果正在飛行，先停止
    if isFlyingToTiki and flyConnection then
        flyConnection:Disconnect()
        flyConnection = nil
    end
    
    -- 重置飛行狀態
    isFlyingToTiki = true
    flightPhase = "ascending"
    targetY = initialY
    waitTimer = 0
    
    -- 顯示開始通知
    game.StarterGui:SetCore("SendNotification", {
        Title = "飛往 Tiki 島",
        Text = "正在起飛到高度 500...",
        Duration = 3
    })
    
    local currentPos = humanoidRootPart.Position
    
    -- 第一步：立即上升到 Y=500
    humanoidRootPart.CFrame = CFrame.new(currentPos.X, targetY, currentPos.Z)
    
    -- 飛行循環
    flyConnection = RunService.Heartbeat:Connect(function(deltaTime)
        if not isFlyingToTiki or not Player.Character then
            if flyConnection then
                flyConnection:Disconnect()
                flyConnection = nil
            end
            return
        end
        
        local hrp = Player.Character:FindFirstChild("HumanoidRootPart")
        if not hrp then
            if flyConnection then
                flyConnection:Disconnect()
                flyConnection = nil
            end
            return
        end
        
        local currentPos = hrp.Position
        
        -- 飛行階段控制
        if flightPhase == "ascending" then
            -- 已經在500高度，切換到等待階段
            flightPhase = "waiting"
            
            game.StarterGui:SetCore("SendNotification", {
                Title = "等待中",
                Text = "在高度 500 等待 1 秒...",
                Duration = 1
            })
            
        elseif flightPhase == "waiting" then
            -- 等待1秒階段
            waitTimer = waitTimer + deltaTime
            
            -- 保持在500高度
            hrp.CFrame = CFrame.new(currentPos.X, initialY, currentPos.Z)
            
            if waitTimer >= 1 then
                -- 等待結束，切換到上升到800階段
                flightPhase = "ascendingTo800"
                targetY = finalY
                
                game.StarterGui:SetCore("SendNotification", {
                    Title = "上升中",
                    Text = "正在上升到高度 800...",
                    Duration = 2
                })
            end
            
        elseif flightPhase == "ascendingTo800" then
            -- 上升到800高度
            hrp.CFrame = CFrame.new(currentPos.X, finalY, currentPos.Z)
            
            -- 切換到水平飛行階段
            flightPhase = "horizontal"
            
        elseif flightPhase == "horizontal" then
            -- 水平飛行階段
            if hasReachedTarget(currentPos) then
                -- 到達目標位置，開始下降
                flightPhase = "descending"
                
                game.StarterGui:SetCore("SendNotification", {
                    Title = "到達 Tiki 島",
                    Text = "正在下降尋找地面...",
                    Duration = 3
                })
            else
                -- 計算朝向目標的方向
                local direction = Vector3.new(targetX, targetY, targetZ) - currentPos
                local horizontalDirection = Vector3.new(direction.X, 0, direction.Z)
                
                if horizontalDirection.Magnitude > 0 then
                    -- 標準化方向並計算移動距離
                    horizontalDirection = horizontalDirection.Unit
                    local moveDistance = 300 * deltaTime
                    
                    -- 如果剩餘距離小於移動距離，直接跳到目標
                    if horizontalDirection.Magnitude * moveDistance > direction.Magnitude then
                        hrp.CFrame = CFrame.new(targetX, targetY, targetZ)
                    else
                        -- 計算新位置
                        local newX = currentPos.X + horizontalDirection.X * moveDistance
                        local newZ = currentPos.Z + horizontalDirection.Z * moveDistance
                        
                        -- 移動到新位置（保持高度targetY）
                        hrp.CFrame = CFrame.new(newX, targetY, newZ)
                    end
                end
            end
            
        elseif flightPhase == "descending" then
            -- 下降階段
            local groundY = findGroundBelow(currentPos)
            
            if math.abs(currentPos.Y - groundY) < 2 then
                -- 已經接近地面，停止下降
                hrp.CFrame = CFrame.new(currentPos.X, groundY, currentPos.Z)
                isFlyingToTiki = false
                
                if flyConnection then
                    flyConnection:Disconnect()
                    flyConnection = nil
                end
                
                game.StarterGui:SetCore("SendNotification", {
                    Title = "成功著陸",
                    Text = "已到達 Tiki 島地面",
                    Duration = 3
                })
            else
                -- 繼續下降
                local descendSpeed = 100  -- 下降速度
                local newY = currentPos.Y - descendSpeed * deltaTime
                
                if newY < groundY then
                    newY = groundY
                end
                
                hrp.CFrame = CFrame.new(currentPos.X, newY, currentPos.Z)
            end
        end
    end)
end
-- ========== 飛到Tiki功能代碼結束 ==========

-- 飛到Tiki按鈕的點擊事件
flyToTikiButton.MouseButton1Click:Connect(function()
    startFlyToTiki()
    
    game.StarterGui:SetCore("SendNotification", {
        Title = "提示",
        Text = "正在飛往 Tiki 島...",
        Duration = 3
    })
end)